<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Placeholders Replace & Restore</title>
    <style>
      body {
        font-family:
          Inter,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial;
        padding: 8px;
        background-color: #c6c6c6;
      }
      label {
        display: block;
        margin-top: 8px;
      }
      select,
      input,
      button {
        margin-top: 6px;
      }
      input[type="text"] {
        width: 100%;
        box-sizing: border-box;
      }
      .row {
        display: flex;
        gap: 4px;
        align-items: center;
        margin-top: 4px;
      }
      .status {
        margin-top: 10px;
        color: #333;
        font-size: 13px;
      }
      small {
        color: #666;
      }
      #minimized-view {
        display: none;
        align-items: center;
        justify-content: space-between;
        height: 100%;
      }
      body.minimized {
        padding: 4px;
      }
      body.minimized #main-view {
        display: none;
      }
      body.minimized #minimized-view {
        display: flex;
      }
    </style>
  </head>
  <body>
    <div id="main-view">
      <h3>Keyword Replacer</h3>

      <label
        >Variable collection:
        <select id="collection"></select>
      </label>

      <label
        >Icon Font Family:
        <input
          id="icon-font-family"
          type="text"
          placeholder="e.g. Font Awesome 6 Free"
        />
      </label>
      <label
        >Icon Font Style:
        <input
          id="icon-font-style"
          type="text"
          placeholder="e.g. Solid"
          value="Regular"
        />
      </label>

      <div class="row">
        <label
          ><input id="toggle" type="checkbox" checked /> Enable automatic
          replace/restore</label
        >
      </div>

      <div class="row">
        <button id="run">Run replace on selection</button>
        <button id="restore">Restore placeholders on selection</button>
      </div>
      <div class="row">
        <button id="minimize">Minimize</button>
        <button id="hide">Hide</button>
        <button id="close">Stop Plugin</button>
      </div>

      <div class="status" id="status">Loading collections…</div>

      <p>
        <small
          >When you finish editing text (select away), @keyword → value. When
          you select text again, it restores @keyword for editing. The plugin
          window must remain open for this to work.</small
        >
      </p>

      <p>
        <small
          >Styling of the keyword depends on the styling of the "@"
          character.</small
        >
      </p>

      <p>
        <small>v0.2</small>
      </p>
    </div>

    <div id="minimized-view">
      <span style="font-size: 11px; color: #333; font-weight: 600"
        >✅ Active</span
      >
      <button id="maximize">Expand</button>
    </div>

    <script>
      const collectionEl = document.getElementById("collection");
      const iconFontFamilyEl = document.getElementById("icon-font-family");
      const iconFontStyleEl = document.getElementById("icon-font-style");
      const toggleEl = document.getElementById("toggle");
      const statusEl = document.getElementById("status");
      const runBtn = document.getElementById("run");
      const restoreBtn = document.getElementById("restore");
      const minimizeBtn = document.getElementById("minimize");
      const hideBtn = document.getElementById("hide");
      const closeBtn = document.getElementById("close");
      const maximizeBtn = document.getElementById("maximize");

      const PLUGIN_COLLECTION_NAME = "KeywordReplacer (plugin)";

      const PLUGIN_WINDOW_WIDTH = 420;
      const PLUGIN_WINDOW_HEIGHT = 530;

      const PLUGIN_WINDOW_WIDTH_MIN = 140;
      const PLUGIN_WINDOW_HEIGHT_MIN = 60;

      parent.postMessage({ pluginMessage: { type: "init" } }, "*");

      onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;
        if (msg.type === "init") {
          collectionEl.innerHTML = "";
          msg.collections.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            collectionEl.appendChild(opt);
          });
          const createOpt = document.createElement("option");
          createOpt.value = PLUGIN_COLLECTION_NAME;
          createOpt.textContent = `Create "${PLUGIN_COLLECTION_NAME}"`;
          collectionEl.appendChild(createOpt);

          toggleEl.checked = !!msg.enabled;
          if (msg.collection) collectionEl.value = msg.collection;
          if (msg.iconFontFamily) iconFontFamilyEl.value = msg.iconFontFamily;
          if (msg.iconFontStyle) iconFontStyleEl.value = msg.iconFontStyle;
          statusEl.textContent = `Feature ${toggleEl.checked ? "ON" : "OFF"} • collection: ${collectionEl.value}`;

          parent.postMessage(
            {
              pluginMessage: {
                type: "resize",
                width: PLUGIN_WINDOW_WIDTH,
                height: PLUGIN_WINDOW_HEIGHT,
              },
            },
            "*",
          );
        } else if (msg.type === "status") {
          statusEl.textContent = msg.text;
        } else if (msg.type === "run-result") {
          statusEl.textContent = `Done: ${msg.results.length} nodes processed. Check console for details.`;
          console.log("run-result", msg.results);
        }
      };

      function sendSettings() {
        parent.postMessage(
          {
            pluginMessage: {
              type: "set",
              enabled: toggleEl.checked,
              collection: collectionEl.value,
              iconFontFamily: iconFontFamilyEl.value,
              iconFontStyle: iconFontStyleEl.value,
            },
          },
          "*",
        );
        statusEl.textContent = `Feature ${toggleEl.checked ? "ON" : "OFF"} • collection: ${collectionEl.value}`;
      }

      collectionEl.onchange = sendSettings;
      iconFontFamilyEl.onchange = sendSettings;
      iconFontStyleEl.onchange = sendSettings;
      toggleEl.onchange = sendSettings;

      runBtn.onclick = () => {
        parent.postMessage(
          { pluginMessage: { type: "run-on-selection" } },
          "*",
        );
        statusEl.textContent = "Running replace on selection…";
      };

      restoreBtn.onclick = () => {
        parent.postMessage(
          { pluginMessage: { type: "restore-on-selection" } },
          "*",
        );
        statusEl.textContent = "Restoring placeholders on selection…";
      };

      minimizeBtn.onclick = () => {
        document.body.classList.add("minimized");
        parent.postMessage(
          {
            pluginMessage: {
              type: "resize",
              width: PLUGIN_WINDOW_WIDTH_MIN,
              height: PLUGIN_WINDOW_HEIGHT_MIN,
            },
          },
          "*",
        );
      };

      hideBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: "hide" } }, "*");
      };

      maximizeBtn.onclick = () => {
        document.body.classList.remove("minimized");
        parent.postMessage(
          {
            pluginMessage: {
              type: "resize",
              width: PLUGIN_WINDOW_WIDTH,
              height: PLUGIN_WINDOW_HEIGHT,
            },
          },
          "*",
        );
      };

      closeBtn.onclick = () => {
        parent.postMessage({ pluginMessage: { type: "close" } }, "*");
      };
    </script>
  </body>
</html>
